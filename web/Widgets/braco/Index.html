<!DOCTYPE html>
<html>
<head>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="js/three.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/OBJLoader.js"></script>
    <script src="js/MTLLoader.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery.csv.min.js"></script>
    <script src="./custom_widget.js"></script>
    <style>
        body {
            overflow: hidden;
            margin: 0;
            padding: 0;
            background: #ffffff);
        }

        p {
            margin: 0;
            padding: 0;
        }

        .left,
        .right {
            position: absolute;
            color: #fff;
            font-family: Geneva, sans-serif;
        }

        .left {
            bottom: 1em;
            left: 1em;
            text-align: left;
        }

        .right {
            top: 0;
            right: 0;
            text-align: right;
        }

        a {
            color: #f58231;
        }
    </style>

</head>
<body>
	<script src="../resources/apis/proxy.js" cwidget="braco" autoResize="disable"></script>
    <script>

        if (!Detector.webgl) {
            Detector.addGetWebGLMessage();
        }

        var container;

        var camera, controls, scene, renderer;
        var lighting, ambient, keyLight, fillLight, backLight;

        init();
        animate();
        var obj_braco=null;
        var obj_arti=null;
        var obj_garra_d=null;
        var obj_garra_e=null;
        var obj_mao=null;
        var obj_base=null;
        var obj_sup=null;
        var obj_est=null;
        var obj_trem=null;
        var object_cont=null;

        function init() {

            container = document.createElement('div');
            document.body.appendChild(container);

            /* Camera */

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 7;
            camera.position.x =4;
            camera.position.y =4;
            /* Scene */

            scene = new THREE.Scene();
            lighting = false;

            ambient = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambient);

            keyLight = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);
            keyLight.position.set(-100, 0, 100);

            fillLight = new THREE.DirectionalLight(new THREE.Color('rgb(215,215,215)'), 0.75);
            fillLight.position.set(100, 0, 100);

            backLight = new THREE.DirectionalLight(0xffffff, 1.0);
            backLight.position.set(100, 0, -100).normalize();

			 ambient.intensity = 0.25;
                    scene.add(keyLight);
                    scene.add(fillLight);
                    scene.add(backLight);

            /* Model */
			var tarpaulin1Material = new THREE.MeshLambertMaterial({color: 0x0F0f0F, transparent: true, opacity: 0.15});

			var mtlLoader2 = new THREE.MTLLoader();
			var objLoader = new THREE.OBJLoader();
            mtlLoader2.setBaseUrl('assets/');
            mtlLoader2.setPath('assets/');

			mtlLoader2.load('lateral.mtl', function (materials) {

                materials.preload();

                materials.materials.default.map.magFilter = THREE.NearestFilter;
                materials.materials.default.map.minFilter = THREE.LinearFilter;

                //var objLoader = new THREE.OBJLoader();
                objLoader.setMaterials(materials);
                /*objLoader.setPath('assets/');
                objLoader.load('MontagemExaustor.obj', function (object) {
					object.position.set( 1, 1, -1 );
					//object.rotation.set( ... )
                    scene.add(object);

                });*/

            });
      //Container
      objLoader.setPath('assets/');
      objLoader.load('cont.obj', function (object) {
				 object.traverse( function ( child ) {
					if ( child instanceof THREE.Mesh ) {
						child.material = tarpaulin1Material;
					}} );
        object.position.set( 0, 0, -3 );
				scene.add(object);
			});

			objLoader.setPath('assets/n/');
      //braco
			objLoader.load('bracoFull_braco.obj', function (object) {
        obj_braco=object;
				obj_braco.traverse( function ( child ) {
						child.material = new THREE.MeshLambertMaterial({color:"#2f2f2f", transparent: false, opacity: 1});
				} );
        //obj_braco.rotation.x=Math.PI/2;
			  obj_braco.position.set( 0, 0, 0 );
				scene.add(obj_braco);
			});

      objLoader.load('unha_direita.obj', function (object) {
        obj_garra_d=object;
        obj_garra_d.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#404040", transparent: false, opacity: 1});
        } );
        obj_garra_d.rotation.x=-Math.PI/2;
        obj_garra_d.rotation.y=Math.PI/2;
        obj_garra_d.position.set( .16, 0, -1.404 );
        scene.add(obj_garra_d);
      });
      objLoader.load('unha_esquerda.obj', function (object) {
        obj_garra_e=object;
        obj_garra_e.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#404040", transparent: false, opacity: 1});
        } );
        obj_garra_e.rotation.x=-Math.PI/2;
        obj_garra_e.rotation.y=Math.PI/2;
        obj_garra_e.position.set( -.16, 0, -1.404 );
        scene.add(obj_garra_e);
      });
      objLoader.load('bracoFull_palma.obj', function (object) {
        obj_mao=object;
        obj_mao.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#202020", transparent: false, opacity: 1});
        } );
        //obj_mao.rotation.y=Math.PI/2;
        obj_mao.position.set( 0, 0, 0 );
        scene.add(obj_mao);
      });
      objLoader.load('bracoFull_trem.obj', function (object) {
        obj_trem=object;
        obj_trem.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#202020", transparent: false, opacity: 1});
        } );
        //obj_mao.rotation.y=Math.PI/2;
        obj_trem.position.set( 0, 0, 1.3   );
        scene.add(obj_trem);
      });
      objLoader.load('bracoFull_articulacao.obj', function (object) {
        obj_arti=object;
        obj_arti.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#202020", transparent: false, opacity: 1});
        } );
        //obj_arti.rotation.y=Math.PI/2;
        obj_arti.position.set( 0, 0, 0 );
        scene.add(obj_arti);
      });
      objLoader.load('bracoFull_base_braco.obj', function (object) {
        obj_sup=object;
        obj_sup.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#2f2f2f", transparent: false, opacity: 1});
        } );
        //obj_sup.rotation.y=Math.PI/2;
        obj_sup.position.set( 0, 0, 0 );
        scene.add(obj_sup);
      });
      objLoader.load('bracoFull_base_deslizante.obj', function (object) {
        obj_base=object;
        obj_base.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#202020", transparent: false, opacity: 1});
        } );
        //obj_base.rotation.y=Math.PI/2;
        obj_base.position.set( 0, 0, 0 );
        scene.add(obj_base);
      });
      objLoader.load('bracoFull_esteira.obj', function (object) {
        obj_est=object;
        obj_est.traverse( function ( child ) {
            child.material = new THREE.MeshLambertMaterial({color:"#606060", transparent: false, opacity: 1});
        } );
        //obj_est.rotation.y=Math.PI/2;
        obj_est.position.set( 0, 0, 1.3 );
        scene.add(obj_est);
        console.log(obj_est.position);
      });



            /* Renderer */

            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            //renderer.setClearColor(new THREE.Color("hsl(45, 0%, 10%)"));
            renderer.setClearColor(new THREE.Color("rgb(215,215,215);")); // COR do fundo

            container.appendChild(renderer.domElement);

            /* Controls */

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enableZoom = false;

            /* Events */

            window.addEventListener('resize', onWindowResize, false);
            //window.addEventListener('keydown', onKeyboardEvent, false);

        }

        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);

        }
		/*
        function onKeyboardEvent(e) {

            if (e.code === 'KeyL') {

                lighting = !lighting;

                if (lighting) {

                    ambient.intensity = 0.25;
                    scene.add(keyLight);
                    scene.add(fillLight);
                    scene.add(backLight);

                } else {

                    ambient.intensity = 1.0;
                    scene.remove(keyLight);
                    scene.remove(fillLight);
                    scene.remove(backLight);

                }

            }

        }
		*/
        function animate() {

            requestAnimationFrame(animate);

            controls.update();

            render();

        }

        function render() {

            renderer.render(scene, camera);

        }

        function move_bra( pos_x, pos_y, pos_z){
          obj_braco.position.set(pos_x, pos_y, pos_z);
          obj_arti.position.set(pos_x, pos_y, pos_z);
          obj_garra_d.position.set(pos_x+.16, pos_y, pos_z-1.404);
          obj_garra_e.position.set(pos_x-.16, pos_y, pos_z-1.404);
          obj_mao.position.set(pos_x, pos_y, pos_z);
          obj_base.position.set(pos_x, pos_y, pos_z);
          obj_sup.position.set(pos_x, pos_y, pos_z);
          obj_est.position.set(pos_x, pos_y, pos_z+1.3);
          obj_trem.position.set(pos_x, pos_y, pos_z+1.3);
        }
        function move_bra_rel( pos_x, pos_y, pos_z){
          obj_braco.position.set(pos_x, pos_y, pos_z);
          obj_arti.position.set(pos_x, pos_y, pos_z);
          obj_garra_d.position.set(pos_x+.16, pos_y, pos_z-1.404);
          obj_garra_e.position.set(pos_x-.16, pos_y, pos_z-1.404);
          obj_mao.position.set(pos_x, pos_y, pos_z);
          obj_base.position.set(pos_x, pos_y, pos_z);
          obj_sup.position.set(pos_x, pos_y, pos_z);
          obj_est.position.set(pos_x, pos_y, pos_z+1.3);
          obj_trem.position.set(pos_x, pos_y, pos_z+1.3);
        }
        function rotate_bra( rot_x, rot_y, rot_z){
            //Rotação lateral
            obj_braco.rotation.y=rot_y;
            obj_arti.rotation.y=rot_y;
            obj_sup.rotation.y=rot_y;
            obj_garra_d.position.x=.16-Math.sin(rot_y)*1.1841;
            obj_garra_e.position.x=-.16-Math.sin(rot_y)*1.1841;
            obj_mao.position.x=-Math.sin(rot_y)*1.1841;
            obj_mao.position.z=(1-Math.cos(rot_y))*1.1841;
            obj_garra_e.position.z=(1-Math.cos(rot_y))*1.1841-1.404;
            obj_garra_d.position.z=(1-Math.cos(rot_y))*1.1841-1.404;
            //Rotação vertical

            //obj_braco.rotation.x=1;
            //obj_braco.rotation.z=-rot_x;

        }
        function Abre_mao( rot){
          obj_garra_e.rotation.y=rot+(3*Math.PI/4);
          obj_garra_d.rotation.y=-rot+Math.PI/2;

        }
        var acc=0;

    //  var intervalID = setInterval(function(){acc++;move_bra(0,0,Math.sin(acc/8));}, 100);

      //  var intervalID1 = setInterval(function(){acc++;rotate_bra(Math.sin(acc/16),Math.sin(acc/16),0);}, 100);
       //var intervalID2 = setInterval(function(){acc++;Abre_mao(Math.sin(acc/16));}, 100);
       function processData(csv) {
          data=csv; //$.csv.toArray(csv);
          pos_z=data[0]/1;
          braco_z=data[1]/1; //0 //carrinho //data[1]/1;
          rot_y=data[2]*Math.PI/180;
          rot_z=data[3]*Math.PI/180;
          rot=data[4];
          obj_braco.position.set(0, 0.3, pos_z+braco_z);
          obj_arti.position.set(0, 0.3+1.1841*Math.sin(rot_z/2), pos_z+braco_z-(Math.cos(rot_z)-1)*1.1841);
          obj_garra_d.position.set(0+.16-Math.sin(rot_y)*1.1841, 0.3+1.1841*Math.sin(rot_z/2), pos_z-1.404+braco_z-(Math.cos(rot_y)-2+Math.cos(rot_z))*1.1841);
          obj_garra_e.position.set(0-.16-Math.sin(rot_y)*1.1841, 0.3+1.1841*Math.sin(rot_z/2), pos_z-1.404+braco_z-(Math.cos(rot_y)-2+Math.cos(rot_z))*1.1841);
          obj_mao.position.set(-Math.sin(rot_y)*1.1841,0.3+1.1841*Math.sin(rot_z/2), pos_z+braco_z -(Math.cos(rot_y)-2+Math.cos(rot_z))*1.1841);
          obj_base.position.set(0, 0.3, pos_z+braco_z);
          obj_sup.position.set(0, 0.3, pos_z+braco_z);
          obj_est.position.set(0,.3, (pos_z/1)+1.3);
          obj_trem.position.set(0,.3, (pos_z/1)+1.3);

          obj_garra_e.rotation.y=-rot*Math.PI/180+(Math.PI);
          obj_garra_d.rotation.y=rot*Math.PI/180;//+Math.PI/2;
			
          obj_braco.rotation.x=rot_z ;//-(Math.sen(rot_z))*(Math.cos(rot_y));
		  obj_braco.rotation.z=-rot_z*rot_y;
		  //obj_braco.rotation.z=rot_y;
		  //obj_arti.rotation.x=rot_z;
		  //obj_arti.rotation.z=rot_z;
		  
          obj_braco.rotation.y=rot_y;
          obj_arti.rotation.y=rot_y;
          obj_sup.rotation.y=rot_y;

		

		}
	   
	   
	   
       var intervalID = setInterval(function(){
										//cwidget.on('carrinho', this.onImageFilesChange.bind(this));
                                        var data=[cwidget.trelica,cwidget.carrinho,cwidget.horizontal,cwidget.vertical,cwidget.mao];
                                        //alert(data);
										//var data=[0,0,0,0,0];
										//data[1]/1
                                         processData(data);
                                      }, 100);

    </script>

</body>
</html>
