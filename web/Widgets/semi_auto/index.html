<!DOCTYPE html>
<html style="overflow: hidden;">
<head>
	
    <script src="./custom_widget.js"></script>
    <title>semi_auto</title>
</head>
<body>
	<script src="../resources/apis/proxy.js" cwidget="semi_auto" autoResize="disable"></script>
	
	<script>
		
		var linha=Number(cwidget.linha);
		var coluna=Number(cwidget.coluna);
		var sensores=Number(cwidget.sensores);
		var zigzag=Number(cwidget.zigzag);
		var dist_x=Number(cwidget.dis_x);
		var dist_z=Number(cwidget.dis_z);
		var offset_y=Number(cwidget.offset_y);
		var mao=Number(cwidget.mao);
		var Y0=0;
		var y_saco=464; //455;//5;//460;
		var h_saco=170;
		var larg_trelica=670;
		var L=885;
		var h_trelica=255;
		var Z0 = h_saco/2 + linha*h_saco;
		var Z1= 558;
		var teta=0;
		var phi=0;
		var Dx=0;
		var iniciar=0;
		var auto=Number(cwidget.auto);
		
		
		cwidget.on("linha", function() {Calcular();});	
		cwidget.on("coluna", function() {Calcular();});											
		cwidget.on("zigzag", function() {Calcular();});
		cwidget.on("dis_x", function() {Calcular();});
		cwidget.on("dis_z", function() {Calcular();});
		cwidget.on("offset_y", function() {Calcular();});

		cwidget.on("iniciar", function() {
											iniciar=Number(cwidget.iniciar);
											enviar();
										});
		cwidget.on("mao", function() {enviar()});
		cwidget.on("parar",function(){
										if (Number(cwidget.parar)){
											cwidget.iniciar=0;
										}
									});
		
		function Calcular() {
				linha=Number(cwidget.linha);
				coluna=Number(cwidget.coluna);
				sensores=Number(cwidget.sensores);
				zigzag=Number(cwidget.zigzag);
				dist_x=Number(cwidget.dis_x);
				dist_z=Number(cwidget.dis_z);
				offset_y=Number(cwidget.offset_y);
				
				Z0 = h_saco/2 + (linha+1)*h_saco;

				if (zigzag){
					
					//zigzag
					//	if (linha % 2){ // impar
					//		Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna-1 +0.5)*(y_saco);//'840+ $offset_y + larg_trelica/2 - ($coluna-1 +0.5)*(y_saco) '  - 250
					//	}
					//	else{ // par
					//		Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (5-coluna +0.5)*(y_saco);
					//	}
					
					
					/// lado para meio / meio para lado
					
						if (linha % 4 ==0){ //linha impar // 12543
							if (coluna<=2){
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna-1 +0.5)*(y_saco);//'840+ $offset_y + larg_trelica/2 - ($coluna-1 +0.5)*(y_saco) '  - 250
							}else{
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (7-coluna +0.5)*(y_saco);
							}
						}
						else if (linha % 4 ==1){ //linha impar // 54123
							if (coluna<=3){
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna+1 +0.5)*(y_saco);//'840+ $offset_y + larg_trelica/2 - ($coluna-1 +0.5)*(y_saco) '  - 250
							}else{
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (5-coluna +0.5)*(y_saco);
							}
						}
						else if (linha % 4 ==2){ //linha par // 34521
							if (coluna<=2){
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (5-coluna +0.5)*(y_saco);
							}else{
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna-3 +0.5)*(y_saco);
							}
						}
						else if (linha % 4 ==3) { //linha par // 32145
							if (coluna<=3){
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (3-coluna +0.5)*(y_saco);
							}else{
								Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna-1 +0.5)*(y_saco);
							}
						}
					
					
					
						
					/// meio para lado	
						
					//	if (linha % 2){ //linha impar // 54123
					//		if (coluna<=3){
					//			Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna+1 +0.5)*(y_saco);//'840+ $offset_y + larg_trelica/2 - ($coluna-1 +0.5)*(y_saco) '  - 250
					//		}else{
					//			Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (5-coluna +0.5)*(y_saco);
					//		}
					//	}
					//	else{ //linha par // 32145
					//		if (coluna<=3){
					//			Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (3-coluna +0.5)*(y_saco);
					//		}else{
					//			Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna-1 +0.5)*(y_saco);
					//		}
					//	}						
						
						
					
				}
				else{
					Y0 = (y_saco*2.5 - 335)+ offset_y + larg_trelica/2 - (coluna-1 +0.5)*(y_saco);
				}

				if ((Z0-Z1-dist_z-h_trelica)/L <= -0.4){ //(Z0<(dist_z-h_trelica)){
					teta = -21;
				}
				else{
					teta= Math.asin((Z0-Z1-dist_z-h_trelica)/L);
					//alert((Z0-Z1-dist_z-h_trelica)/L);
					teta = (teta*180)/Math.PI;
				}
				if (teta < -21){
					teta = -21;
				}
				else{ if (teta>11){
					teta=11;
					}
				}
				
				phi=Math.asin( (Y0) / (204+160+L*Math.cos((teta/180)*Math.PI)));
                
				if ((phi>0.6 || phi<-0.6) && teta<=-8){
					teta=-8;
					phi = Math.asin( (Y0) / (204+160+L*Math.cos((teta/180) *Math.PI)) );
				}
				
				Dx= 204+160 +  L * Math.cos( (27/180) * Math.PI ) - (204+160 + L *(2*Math.cos( (teta/180) * Math.PI ) - Math.cos( (27/180) * Math.PI)))*Math.cos(phi);
				Dx = dist_x + 100 + Dx;
				
				while (Dx > 1400){
					teta=teta+0.1;
					phi = Math.asin( (Y0) / (204+160+L*Math.cos((teta/180) *Math.PI)) ) ;
					Dx = 204+160 +  L * Math.cos( (27/180) * Math.PI ) - (204+160 + L *(2*Math.cos( (teta/180) * Math.PI ) - Math.cos( (27/180) * Math.PI)))*Math.cos(phi);
					Dx = dist_x + 100 + Dx;
					if (teta>=-11){
						break;
						alert('Erro de calculo - Dx>1400 e teta > -11');
					}
				}
				
				phi = (phi*180)/Math.PI;
                //
				cwidget.teta = (-211/38)*(teta-11);
                //
				cwidget.phi = phi*1000/3;
				
				cwidget.phi2= phi*80*2500/(4*360);
				//
				cwidget.car = Dx * 15.714;
				
				

		}
		function enviar(){
				mao=Number(cwidget.mao);
				auto=Number(cwidget.auto);
				iniciar=Number(cwidget.iniciar);
				
				if (iniciar && mao){
					
					cwidget.Posicao_trelica_final=Number(cwidget.Ntrel)/0.31;
					cwidget.Posicao_carrinho_final = Number(cwidget.car);
					cwidget.Posicao_lat_bra_phi_final = Number(cwidget.phi);
					cwidget.Posicao_lat_bra_phi_final2 = Number(cwidget.phi2);
					cwidget.Posicao_ver_bra_teta_final = Number(cwidget.teta);
					cwidget.Inicia_movimento=1;
					if (auto){			
						cwidget.n_sacos=Number(cwidget.n_sacos)+1;
					}
					else{
						cwidget.iniciar=0;
					}
				}
				
				if (!mao && Number(cwidget.Inicia_movimento)){
					cwidget.Inicia_movimento=0;
					if (coluna<5){
						cwidget.coluna=coluna+1;
					}
					else if(linha<=14){ 
						cwidget.coluna=1;
						cwidget.linha=linha+1;
						if (Number(cwidget.linha>=6)){
							cwidget.dis_z=950;
							//cwidget.Altura_trelica=1;
							
							cwidget.parar=1;
							cwidget.iniciar=0;
							alert('Levantar treliça');
						}
						if(Number(cwidget.linha==15)){
							cwidget.dis_z=800;
							//cwidget.Altura_trelica=0;							
							
							cwidget.linha=1;
							cwidget.parar=1;
							cwidget.iniciar=0;
							alert('Baixar treliça');
						}
					}
				}
		}
	</script>
	<script>
		setTimeout(function(){ Calcular(); cwidget.parar=1; }, 4000);
	</script>
</body>
</html>